## 参考笔记

[计算机网络笔记-第一章-概述 - 欢迎来到我的博客~ (crwei996.github.io)](https://crwei996.github.io/2022/09/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0-%E7%AC%AC%E4%B8%80%E7%AB%A0/)
[计算机网络（自顶向下方法）学习笔记_计算机网络自顶向下方法_头秃的程序员小王的博客-CSDN博客](https://blog.csdn.net/qq_39326472/article/details/88089747)
[计算机网络（自顶向下方法）读书笔记----吐血整理_wx60dc8ce39e154的技术博客_51CTO博客](https://blog.51cto.com/u_15290941/3277160)


## 计算机网络和互联网

### 什么是网络

**网络(network)** 是由边和节点组成的与大小形状无关的拓扑。**计算机网络(computer network)** 是联网的计算机构成的系统。**互联网(因特网，Internet)** 是由以TCP/IP为主的一簇协议支撑的网络。

从具体构成角度看，互联网的节点是 **主机/端系统(host/end system)** 和 **分组交换机(packet switch)** ，边是**通信链路(communication link)**。分组交换机两种重要的类型分别是工作在网络层(Network Layer)的 **路由器(router)** 和工作在链路层(Data link layer)的 **链路层交换机(link-layer switch)** 。

**协议(protocal)** 是对等层的实体在通信的过程中应该遵循的规则的集合，遵守同一协议的实体才能通信。**TCP(Transmission Control Protocol, 传输控制协议)** 和 **IP(Internet Protocol, 网际协议)** 是互联网中两个重要的协议。互联网标准(Internet standard)是以请求评论(Request for comments, RFC)的文档形式，在互联网工程任务组(Internet Engineering task Force, IETF)的网站上发布的。

从应用程序提供服务的基础设施的角度看，互联网包括 **分布式应用进程(distributed application)** 和向进程提供通信服务的基础设施。

### 网络边缘

互联网网络边缘是端系统，接入网是将端系统物理连接到其 **边缘路由器(edge router)** 的网络，边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器，网络核心是分组交换机和链路组成的网状网络。

应用进程之间通信的两种模式，**客户/服务器(client/sever)模式** (如Web浏览器/服务器)，**对等(peer-to-peer, P2P)模式** (迅雷首创的下载技术P2SP通过检索数据库把服务器资源和P2P资源整合到了一起)。

`思考：百度网盘为什么没有搜索功能(公开性问题)？我们上传网盘的资源最后去了哪里(云服务器)？网盘是如何搜索违禁资源的(哈希值，违禁词检测，AI扫描等)？

### 网络核心

通过网络链路和交换机移动数据有两种基本方法：**电路交换(circuit switching)** 和 **分组交换(packet switching)**。电路交换在两台主机要通信时，网络会在两台主机之间创建一条专用的 **端到端连接(end-to-end connection)**。电路交换通过 **频分复用(Frequency-Division Multiplexing, FDM)** 或 **时分复用(Time-Division Multiplexing, TDM)** 来实现的。分组交换在端系统间交换 **报文(message)**，长报文会划分为小的数据块，称为 **分组(packet)**。分组交换机在链路输入端使用 **存储转发传输(store-and-forward transimission)** 机制；每条相连的链路分组交换机具有一个 **输出缓存/输出队列(output buffer, output queue)**，用于存储路由器准备发往那条链路的分组。除了存储转发时延外，分组还要承受输出缓存的 **排队时延(queuing delay)**。因为缓存空间大小是有限的，分组到达缓存可能是没有空间的，这种情况下将出现 **分组丢失(包)(packet loss)**。分组交换按需分配链路使用，用可变长的排队时延和有可能出现的分组丢失的代价，获取了共享性。分组交换是一种统计多路复用，同样的网络资源下，允许更多用户使用网络！

`思考：路由(决定分组采用的源到目标的路径，即路由算法)帮助转发(将分组从路由器的输入链路转移到输出链路，即路由表))是如何配合的？分组交换中如何实现类似电路交换的服务(多媒体的专用线路)？分组交换中虚电路(virtual circuit)和数据报(datagram)的方式区别在于(是否建立连接)？`

### 接入网和物理媒体

**因特网服务供应商(Internet Service Provider，ISP)** 起初利用已有的线路资源为住宅接入互联网，使用 **调制解调器(Modem，猫)** 将上网数据通过电话线传输(数据波形形似冲浪)，这种拨号上网的方式缺点是带宽窄，而且上网和打电话不能同时进行。 后来单根 **数字用户线(Digital Subscriber Line，DSL)** 线路按照不同频率编码分为电路呼叫和供互联网连接的上行和下行通道(FDM)，上行和下行带宽不对称叫做 **非对称数字用户线(Asymmetric Digital Subscriber Line，ADSL)**。除了DSL(电话公司)，住宅接入网络的形式还有电缆接入(有线电视公司)，**光纤到户(Fiber To The Home，FTTH)** 和 卫星链路。

计算机网络按照网络覆盖范围分为 **局域网(Local Area Network，LAN)** 和 **广域网(Wide Area Network)** 。企业(和家庭)接入使用LAN将端系统连接到边缘路由器，有线LAN技术比如 **以太网(Ethernet)** ，无线LAN技术(Wireless Local Area Nrtwork, WLAN)  比如 **Wifi (Wireless Fidelity)**，**蓝牙(Bluetooth)** 等 。无线接入还有广域无线接入(4G，5G等)。

传输信号的物理媒体分为 **导引型媒体(guided media)** 和 **非导引型媒体(unguided media)** 。导引型媒体，电波沿着固体媒体前行，如光缆、双绞铜线(电话网络)或同轴电缆(有线电视网络)；非导引型媒体，电波在空气或外层空间中传播，如无线局域网、无线广域网或卫星链路。

`思考：目前生活中用到的几种网络技术分类(插网线连接校园网属于有线LAN技术，手机流量上网属于无限WAN技术)？猫的背后有一个WAN和多个LAN口(供应商网线连WAN口，电脑网线连LAN口)？通信中常用两种卫星，同步卫星(geostationary satellite)(始终在地球上方相同点，延迟高)和近地卫星(Low-Earth Orbiting, LEO)(马斯克的星链计划)？家用以太网和工业以太网的区别(工业以太网会用一些特殊的协议或技术，还通常会使用一些专门的工业级交换机等设备以满足工业环境要求)？`

### Internet结构和ISP

![[net1.jpg]]
今天的互联网是一个网络的网络。较低层的ISP与较高层的ISP相连(涉及费用结算)，较高层的ISP彼此互联(不涉及费用结算)。除了第一层的ISP可以选择 **多宿(multi-home)** 即可以与两个或更多供应商ISP连接。第三方公司也会创建 **因特网交换点(Internet Exchange Point，IXP)** 帮助同一层ISP互联。**互联网内容提供商(INternet Content Provider，ICP)** 有些也会建立自己的专有网络(如谷歌分布全球的数据中心)，同时与各级互联。

`思考：数据中心通常离 ISP 很近，但有些建在海底和北极，为什么(省电)？`

### 分组延时、丢失和吞吐量

分组在沿途的每个节点经受几种不同的时延，包括 **节点处理时延(nodal processing delay)**，**排队时延(queuing delay)**，**传输时延(transmission delay)** 和 **传播时延(propagation delay)**，这些时延总体累加起来是 **节点时延(total nodal delay)**。令 $a$ 表示分组到达队列的平均速率(分组/秒，pks/s)，$R$是从队列中推出比特的速率(bps)，简单起见假定所有分组都是$L$比特组成的，则比特到达队列的平均速率是 $La$ bps，假定队列非常大能容纳无限量的比特，比率 $La/R$ 称为 **流量强度(traffic intensity)** (好比马路上容纳的车达到了它的容纳量就会发生堵车)。在流量工程中，设计系统时流量强度不能大于1。因为排队容量是有限的，随着流量强度接近1，排队时延并不会真正趋向无穷大，当到达的分组发现队列已满，路由器将丢弃(drop)该分组，分组将丢失(lost)。常用于网络诊断的 `ping` `和traceroute` 命令是基于 **ICMP(Internet Control Message Protocol，互联网控制消息协议)** 实现的，是互联网协议族中重要的协议之一。吞吐量是源端和目标端之间传输的速率(数据量/单位时间)，有 **瞬时吞吐量(instantaneous throughput)** 和 **平均吞吐量(average throughput)**。

### 协议层次及服务模型

将网络复杂的功能分成功能明确的层次，每一层实现一个或一组功能，功能中包括向上一层提供的 **服务(service)** 。**协议(protocol)** 的目的是为了向上层提供更好的服务，协议是通过层间的接口访问下层所提供的的服务实现的。服务又分为面向连接的服务(Connection-oriented Service)(比如打电话，比如虚电路)和无连接的服务(Connectionless Service)(比如寄信件，比如数据报)。

![[net2.jpg]]

下层(Layer n)是 **服务用户(service user)**，上层(Layer n+1)是 **服务提供者(service provider)**，下层通过层间接口 **SAP(Service Access Point，服务访问点)** 向上层提供服务，服务的形式叫做 **原语(primitve)**。上层的的 SDU 要穿过 SAP 前部要加 ICI 形成 IDU， 送到下层的 SDU 按照下层的协议在前部加入下层的 Header 后形成下层的 PDU，对等层实体的信息交换是以 PDU 的形式实现的。

互联网的 **协议栈(protocol stack)** 由5个层次组成：物理层、链路层、网络层、传输层和应用层。物理层把帧中的 **比特/位(byte/bit)** 通过物理媒体从一个节点移动到下一个节点；链路层在物理层提供的服务基础之上，在相邻的两个节点之间传输以 **帧(frame)** 为单位的数据(PPP，802.11(wifi)，Ethernet)；网络层在链路层提供的点到点的服务基础之上，实现以 **分组(packet)** 为单位的端到端的数据传输(IP，路由协议)；传输层在网络层提供的端到端的服务基础之上，实现进程到进程之间 **报文段(segment)** 的交互(TCP，UDP)；应用层在传输层提供的进程与进程间服务基础上，以 **报文(message)** 的形式为人类应用或者其他应用进程提供网络应用服务(FTP，SMTP，HTTP，DNS)。**开放式系统互连通信参考模型(Open System Interconnect，OSI)** 定义了网络互连的七层框架：物理层(Physical Layer)，数据链路层(Data link layer)，网络层(Network Layer)，运输层(Transport layer)，会话层(Session Layer)，表示层(Presentation Layer)，应用层(Application Layer)。

`思考：会话层和表示层在互联网协议栈中有体现么(有，在应用层面)？在路由器和链路层交换机要经过几层封装(encapsulation)和解封装(三层和两层)？位，帧，分组和报文属于是各层次的(等层交换形式是PDU)？SDU的传输存在一对一，一对多，多对一的复杂情况是怎么处理的？`

### 历史

1961-1972：早期分组交换概念(ARPAnet)；1972-1980：专用网络和网络互联(Cerf and Kaha 定义了今天的互联网体系结构)；1980-1990：体系结构变化，网络数量激增，应用丰富；1990-2005：商业化，Web，新的应用(好的互联网公司沉淀下来)；2005-现在(移动终端，物联网，5G，云服务等)...

`思考：如何看待互联网行业马太效应赢者通吃(监管局介入)？`

## 应用层

### 应用层原理

研发网络应用程序的核心是写出能够运行在不同端系统和通过网络彼此通信的程序。现代网络应用程序使用的两种主流体系结构是：客户-服务器体系结构或对等(P2P)结构。**C/S体系结构** 客户端之间不直接通信，服务器有固定的IP地址和周知的端口号，并保持一直运行，常常出现一台服务器主机跟不上它所有客户请求的情况，为此很多流行的互联网服务——搜索引擎(Google，Bing，Baidu)，互联网商务(Amazon，e-bay，Alibaba)，基于Web的电子邮件(Gmail)，社交网络(Facebook，Instagram，Twitter，WeChat)都应用了许多有着大量主机的数据中心。**P2P体系结构** 中对等方不为服务提供商所有，自扩展性(self-scalability)好，应用包括有文件共享(BitTorrent)，协助下载加速器(Thunder)，互联网电话和视频会议(Skype)。在同一端系统中，进程通信规则由端系统上的操作系统确定；在不同端系统间，进程通过计算机网络交换报文相互通信。

![[net3.jpg]]

为了标识接收进程，需要定义两种信息：主机的地址 **IP地址(IP address)**；在目的主机中接收进程的标识符 **端口号(port number)**。流行的应用如Web服务器使用端口号80，邮件服务器使用端口号25，FTP服务器使用端口号21。应用层与传输层互相交付的信息包括数据段(SDU)，发送方应用进程的标识(IP+TCP/UDP Port)，接收方应用进程的标识(IP+TCP/UDP Port)。对于使用面向连接服务(TCP)的应用而言，**套接字(socket)** 是四元组(源IP，源Port，目标IP，目标Port)的一个具有本地意义的标识(使得穿过层间接口的信息量最小)。对于使用无连接(UDP)的应用而言，套接字是二元组的一个具有本地意义的标识(在发送报文的过程中必须指定对方IP和Port)。应用层需要传输层提供的服务，可以大致从四个方面进行分类，可靠数据传输， 吞吐量，定时和安全性。TCP提供面向连接的，可靠数据传输服务，拥有流量控制和拥塞控制的特性，不具备时间保证、最小吞吐保证和安全性的特性；UDP提供无连接的，不可靠数据传输服务。**安全套接字层(Secure Sockets Layer, SSL)** 在TCP上实现了安全性服务。

`思考:怎么理解TCP上的socket(发送方和接收方本地都存有一个四元组和套接字的映射表，每个套接字都唯一指定了一个会话，不必在每次发送都指定四元组，类似于OS中使用文件句柄而不是文件本身，简单且易于管理)?UDP没有TCP的特性，为什么还需要UDP(能区分不同的进程，IP服务不能区分；无需建立连接，省去时间；不做可靠性的工作，适合可靠性要求不高的场合；没有拥塞控制和流量控制，能按照设定速度发送数据)？套接字会在传输层间传递么(不会，套接字是本地意义标识，传输层传递的是具有标识意义的套接字映射值)？`

### Web与HTTP

**Web页面(Web page，网页)** 由对象组成，这样的对象可以是一个HTML文件，一个JPEG图形，一个Java小程序或者一个视频片段这样的文件，且都可以通过一个URL寻址。举例，URL地址`Port://user:psw@www.someSchool.edu/someDept/pic.gif:port`中`Prot`是协议名，`user:psw`是用户和口令，`www.someSchool.edu`是主机名，`/someDept/pic.gif`是路径名，`port`是端口号。

`思考：怎么理解C++中的对象和Web页面中的对象(C++中的对象是面向对象编程的基本单位，是对现实世界某个实体或概念的抽象；Web页面中的对象是对页面中的元素进行抽象，可以是文本图像等，有自己的特性和操作)？一下搞清URL,HTML,HTTP(HTML是创建网页的语言，相同的还有CSS和JavaScript；URL是定位和标识互联网上资源的地址；HTTP是Web浏览器和Web服务器之间传输数据的协议)?`

HTTP使用TCP作为它的传输协议。客户发起一个与服务器的TCP连接，服务器接受客户的TCP连接；在浏览器(HTTP客户端)和Web服务器(HTTP服务端)交换HTTP报文(应用层协议报文)；TCP连接关闭。服务器会创建一个守候socket并设置为监听状态，它会接受来自客户端发送到服务端的请求，并创建新的连接socket，用于和客户端进行通讯。按照每个请求/响应对分别经过一个单独的TCP连接发送，还是所有的请求/响应对经过同一个的TCP连接发送，可分为 **非持续链接(non-persistent connection)** (HTTP1.0默认连接方式)和 **持续连接(presistent connection)**(HTTP1.1默认连接方式) 。定义 **往返时间(Round-Trip Time, RTT)** 为一个短分组从客户到服务端再返回客户所花费的时间。总的响应时间包括两个RTT加上服务器传输HTML的时间。第一个RTT是“三次握手”的前两个部分时间(客户向服务器发送一个小TCP报文段；服务器回复一个小TCP报文段做确认和响应)，第二个RTT是“三次握手”的第三个部分(客户向服务器发送确认)。客户端向服务端发送HTTP请求报文，服务器收到后返回HTML文件。

![[net4.jpg]]


对于请求报文的通用格式，第一行叫做 **请求行(request line)** ，其后继的行叫做 **首部行(header line)** 。请求行有3个字段：方法字段、URL字段和HTTP版本字段 `GET /somedir/page.html HTTP/1.1` 。方法字段可以取包括GET、POST、HEAD、(PUT和DELETE，HTML1.1)。使用GET方法时为请求报文，此时 **实体体(Entity Body)** 为空，使用POST方法时才使用实体体(比如用户向搜索引擎停供关键词)。

对于响应报文的通用格式，第一行叫做 **状态行(status line)** ，其后继的行是首部行，以及实体体。状态行有3个字段：协议版本字段、状态码和相应状态信息 `HTTP/1.1 200 OK`。常见的状态码和相关状态信息有：`200 OK` 请求成功，信息在返回的响应报文中；`404 Not Found` 请求的文档不在服务器上。

![[net5.jpg]]![[net6.jpg]]

HTTP是无状态(服务器不维护客户端的状态)的协议。cookie技术有4个组件：1. 在HTTP响应报文中的一个cookie首部行；2. 在HTTP请求报文中的一个cookie首部行；3. 在用户端系统中保留一个cookie文件，并由用户浏览器管理；4. 位于Web站点的一个后端数据库。用户首次访问一个站点，可能需要提供用户标识。在后继会话中，浏览器向服务器传递一个cookie首部，从而向该服务器标识了用户。因此cookie可以在无状态的HTTP之上建立一个用户 **会话层**。cookie带来便利的同时也带来了隐私上的问题，很多Web站点可以知道很多用户信息(比如从网站点击顺序看出个人使用偏好)，并可能将这些信息卖给第三方。

`思考：怎么理解响应报文返回首部行内容长度(应用层负责区分报文边界，传输层负责传输报文段)？怎么理解cookie技术(用户首次访问服务器，服务器会保存用户数据并在响应报文中返回一个cookie值，客户端保存返回的cookie值；在下次访问过程中请求报文携带此cookie值，服务器可以使用该cookie查询数据库执行相关的行为)？`

**Web缓存器(Web cache)** 也叫 **代理服务器(proxy server)**，它是能够代表初始Web服务器来满足HTTP请求的网络实体。假设浏览器请求某网站对象，会发生如下情况：1. 浏览器创建一个到Web缓存器的TCP连接，并向Web缓存器中的对象发送一个HTTP请求；2. Web缓存器进行检查，检查本地是否存储对象副本.如果有，Web缓存器向客户浏览器用HTTP响应报文返回该对象。3. 如果Web缓存器没有该对象，它就打开一个与该对象的初始服务器的TCP连接。Web缓存器则在这个缓存器到服务器的TCP连接上发送一个对该对象的HTTP请求。在收到请求后，初始服务器向该Web缓存器发送具有该对象的HTTP响应。4.  当Web缓存器接受到该对象时，它在本地存储一份副本，并向客户浏览器用HTTP响应报文发送该副本。值得注意的是，Web缓存器既是服务器又是客户。通常Web缓存器由ISP安装，常见于大学、公司和居民区等地。使用Web缓存器，一是可以降低客户端的请求响应时间；二是可以减少一个机构内部网络与互联网接入链路上的流量；三是互联网存在的大量缓存使得弱的ICP也能被有效提供。

`思考：怎么理解Web缓存器或者代理服务器(通过在网络间设置代理服务器，类似缓存，缓存命中则从缓存器中返回对象，不在缓存中则缓存器再请求原始服务器)？从ISP和网络主管的角度怎么看待网速(ISP会推荐网络用户升级带宽，致使流量强度减少，有效减少排队延迟；网络主管会在本地局域网安装缓存节点，根据二八定律满足以更快的速度用满足更多更频繁的请求，有效降低请求响应时间)？`

### FTP

早期的文件分发通过FTP实现。FTP服务器守候在21号端口，等待来自FTP客户端的连接建立请求，建立的具有控制性的TCP连接称为 FTP控制连接 。在这个控制连接上完成用户认证，之后客户端可以向服务器发送一系列指令。客户端从服务器的相应目录上载和下载文件，是服务器向客户端的另一个端口发起的数据连接完成的。 FTP是一个有状态的连接，维护信息包括当前路径、用户账户与控制连接的对应。

`如何理解上载和下载(相对客户端和服务器而言)？`

### Email

因特网电子邮件系统由3个主要组成部分：**用户代理(user agent)**，**邮件服务器(mail server)**，**简单邮件传输协议(Simple Mail Transfer Protocol，SMTP)**。SMTP使用可靠数据传输服务，从发送方的邮件服务器向接收方的邮件服务器发送邮件。在一个邮件服务器向其他邮件服务器发送邮件时，它就表现为SMTP的客户；当邮件服务器从其他邮件服务器接受邮件时，它就表现为SMTP的服务器。SMTP的陈旧特征限制邮件报文体部分只能采用ASCII表示，这导致许多现在的附件不得已要在传输前后编码成ASCII码。HTTP主要是一个 **拉协议(pull protocol)**，STMP基本上是一个 **推协议(push protocol)**。

典型的用户通常在本地PC上运行一个用户代理程序，它会访问存储在总是保持开机的共享邮件服务器上的邮箱，该邮件服务器与其他用户共享，通常由ISP进行维护(比如大学或公司)。发送方的用户代理把邮件推到发送方的邮件服务器，发送方的邮件服务器把邮件推到接收方的邮件服务器，都是使用SMTP；而接收方是通过邮件访问协议把邮件从接收方的邮件服务器拉到接收方的用户代理。目前流行的邮件访问协议有，**第三版邮局协议(Post Office Protocol_Version 3，POP3)**，**因特网邮局访问协议(Internet Mail Access Protocol，IMAP)** 以及HTTP。

`邮件代理是什么(常见有Outlook，Foxmail等)？如何理解邮件的发送(从发送方的用户代理开始，传输到发送方的邮件服务器，再传输给接收方的邮件服务器，接收方登录自己的邮件代理，从接收方的邮件服务器获取邮件)？怎么理解Web服务器的端口是80，FTP服务器的端口是21，油箱服务器的端口是25这种固定的端口？`
### DNS

主机的一种标识方式是 **主机名(hostname)**，另一种是IP地址，人们便于记忆主机名标识方式，而路由器则喜欢定常的有层次结构的IP地址。**域名系统(Domain Name System，DNS)** 是一个由分层的 **DNS服务器(DNS server)** 实现的分布式数据库，一个使得主机能够查询分布式数据库的应用层协议。DNS运行在UDP之上，使用53号端口，它在其他应用层协议中(包括HTTP、SMTP和FTP)使用，将用户提供的主机名解析为IP地址。DNS还包括一些其他服务，比如 **主机别名(host aliasing)**，主机别名会比 **主机规范名(canonical hostname)** 更容易记忆；**邮件服务器别名(mail server aliasing)**；**负载分配(load distribution)**。

`从用户角度怎么理解DNS的主机名到IP的转换(比如，某用户主机上的浏览器要请求URL，为了使用户主机能将HTTP请求报文发送到Web服务器，必须知道Web服务器的IP地址，此时浏览器会从URL中抽取出对应主机名，向附近的DNS服务器发送请求，在得到DNS服务器响应的对应主机名转换后的IP地址，浏览器可以向Web服务器的IP地址发起TCP连接)？`

从用户主机上调用的应用程序看，DNS查询是一个简单直接的黑盒，但事实上实现这个服务非常复杂，它是由分布于全球大量的DNS服务器以及定义了DNS服务器与查询主机通信方式的应用层协议组成。单一的DNS服务器存在单点故障，通信容量，远距离的集中式数据库和维护困难的问题，没有可扩展能力。没有一台DNS服务器上能拥有因特网所有主机的映射，相反这些映射分布在所有DNS服务器上。总共有3中类型DNS服务器：根DNS服务器、顶级域(Top-Level Domain，TLD)DNS服务器和权威DNS服务器。